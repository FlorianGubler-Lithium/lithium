name: Deploy a specific Environment
on:
  workflow_call:
    inputs:
      chart:
        required: true
        type: string
      environment:
        required: true
        type: string
jobs:
  setup:
    runs-on: ${{ inputs.environment }}
    
    outputs:
      chart: ${{ github.event.inputs.chart }}
      environment: ${{ github.event.inputs.environment }}
      
    permissions:
      contents: read
      packages: read

    steps:
    - uses: actions/checkout@v4

    - name: Install Helm
      uses: azure/setup-helm@v4

    - name: Set dynamic kubeconfig secret
      run: |
        if [ "${{ github.event.inputs.environment }}" = "development" ]; then
          echo "KUBECONFIG=${{ secrets.KUBECONFIG_DEV }}" >> $GITHUB_ENV
        else
          echo "KUBECONFIG=${{ secrets.KUBECONFIG_PROD }}" >> $GITHUB_ENV
        fi
          
    - name: Configure Kubeconfig
      uses: azure/k8s-set-context@v4
      with:
        method: kubeconfig
        kubeconfig: ${{ env.KUBECONFIG }}
    
    - name: Extract branch
      shell: bash
      run: echo "revision=$( echo ${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}} | sed 's/\//-/g')" >> $GITHUB_OUTPUT
      id: branch
        
    - name: Deploy the Helm chart
      run: | 
        CHART_NAME=${{ needs.setup.outputs.chart }}
        ENVIRONMENT=${{ needs.setup.outputs.environment }}
        if [[ "$CHART_NAME" == "*" ]]; then
          CHART_PATHS=$(find ./charts -mindepth 1 -maxdepth 1 -type d)
        else
          CHART_PATHS="./charts/$CHART_NAME"
        fi

        for path in $CHART_PATHS; do
          echo "Deploying $path to $NAMESPACE (dev)"
          helm upgrade --install $(basename "$path") "$path" \
            --values "$path/$ENVIRONMENT/values.yaml"
        done
